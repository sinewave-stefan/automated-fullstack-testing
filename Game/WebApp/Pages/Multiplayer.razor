@page "/multiplayer"
@using global::Game.Core
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable

<PageTitle>Multiplayer Game</PageTitle>

<h1>Multiplayer Game - Server Communication</h1>

@if (!isConnected)
{
    <div class="alert alert-warning">
        <p>Connecting to server...</p>
        <button class="btn btn-primary" @onclick="Connect">Reconnect</button>
    </div>
}
else
{
    <div class="alert alert-success">
        <p>‚úÖ Connected to server as @playerId</p>
    </div>
}

<div class="game-container">
    <div class="info-panel">
        <h3>Your Player Status</h3>
        @if (myPlayer != null)
        {
            <p><strong>Name:</strong> @myPlayer.Name</p>
            <p><strong>Health:</strong> @myPlayer.Health / @myPlayer.MaxHealth</p>
            <p><strong>Position:</strong> (@myPlayer.PositionX.ToString("F1"), @myPlayer.PositionY.ToString("F1"))</p>
            <p><strong>Status:</strong> @(myPlayer.IsAlive ? "Alive" : "Dead")</p>
        }
        else
        {
            <p>No player data yet...</p>
        }
    </div>

    <div class="controls">
        <h3>Controls</h3>
        <button class="btn btn-primary" @onclick="MoveUp" disabled="@(!isConnected)">‚Üë Move Up</button>
        <button class="btn btn-primary" @onclick="MoveDown" disabled="@(!isConnected)">‚Üì Move Down</button>
        <button class="btn btn-primary" @onclick="MoveLeft" disabled="@(!isConnected)">‚Üê Move Left</button>
        <button class="btn btn-primary" @onclick="MoveRight" disabled="@(!isConnected)">‚Üí Move Right</button>
        <br />
        <button class="btn btn-danger" @onclick="TakeDamage" disabled="@(!isConnected)">üí• Take Damage (10)</button>
        <button class="btn btn-success" @onclick="Heal" disabled="@(!isConnected)">‚ù§Ô∏è Heal (20)</button>
    </div>

    <div class="players-list">
        <h3>All Players (@allPlayers.Count)</h3>
        @foreach (var p in allPlayers)
        {
            <div class="player-item @(p.Id == playerId ? "current-player" : "")">
                <strong>@p.Name</strong> - HP: @p.Health/@p.MaxHealth - Pos: (@p.PositionX.ToString("F1"), @p.PositionY.ToString("F1"))
            </div>
        }
    </div>

    <div class="ai-demo">
        <h3>Server AI</h3>
        <p><strong>AI Position:</strong> (@aiPosition.X.ToString("F1"), @aiPosition.Y.ToString("F1"))</p>
        <button class="btn btn-info" @onclick="UpdateAI" disabled="@(!isConnected)">ü§ñ Update AI</button>
    </div>

    <div class="canvas-placeholder">
        <h3>Rendering Area (All Players)</h3>
        <p>This shows all connected players and the server AI in real-time.</p>
        <div class="render-canvas">
            @foreach (var p in allPlayers)
            {
                var color = p.Id == playerId ? "blue" : "green";
                var left = 300 + p.PositionX * 10;
                var top = 200 + p.PositionY * 10;
                <div class="player-marker" style="left: @(left)px; top: @(top)px; background: @color; opacity: @(p.IsAlive ? 1 : 0.3);">
                    <span class="player-label">@p.Name</span>
                </div>
            }
            
            <div class="ai-marker" style="left: @(300 + aiPosition.X * 10)px; top: @(200 + aiPosition.Y * 10)px;">
                <span class="ai-label">AI</span>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private bool isConnected = false;
    private string playerId = "";
    private PlayerDto? myPlayer;
    private List<PlayerDto> allPlayers = new();
    private PositionDto aiPosition = new() { X = 0, Y = 0 };

    protected override async Task OnInitializedAsync()
    {
        await Connect();
    }

    private async Task Connect()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl("http://localhost:5200/gamehub")
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<string>("PlayerCreated", (connectionId) =>
            {
                playerId = connectionId;
                InvokeAsync(StateHasChanged);
            });

            hubConnection.On<GameStateDto>("GameStateUpdated", (state) =>
            {
                allPlayers = state.Players;
                myPlayer = allPlayers.FirstOrDefault(p => p.Id == playerId);
                aiPosition = state.AIPosition;
                InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
            isConnected = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Connection error: {ex.Message}");
            isConnected = false;
        }
    }

    private async Task MoveUp() => await hubConnection?.SendAsync("MovePlayer", 0f, -1f)!;
    private async Task MoveDown() => await hubConnection?.SendAsync("MovePlayer", 0f, 1f)!;
    private async Task MoveLeft() => await hubConnection?.SendAsync("MovePlayer", -1f, 0f)!;
    private async Task MoveRight() => await hubConnection?.SendAsync("MovePlayer", 1f, 0f)!;
    private async Task TakeDamage() => await hubConnection?.SendAsync("TakeDamage", 10)!;
    private async Task Heal() => await hubConnection?.SendAsync("Heal", 20)!;
    private async Task UpdateAI() => await hubConnection?.SendAsync("UpdateAI")!;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

<style>
    .game-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .info-panel, .controls, .ai-demo, .canvas-placeholder, .players-list {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        background: #fff;
    }

    .btn {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }

    .btn:hover:not(:disabled) {
        opacity: 0.9;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .canvas-placeholder {
        grid-column: 1 / -1;
        text-align: center;
    }

    .alert {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #28a745;
    }

    .player-item {
        padding: 5px;
        margin: 5px 0;
        border-radius: 3px;
        background: #f8f9fa;
    }

    .current-player {
        background: #cfe2ff;
        font-weight: bold;
    }

    .render-canvas {
        position: relative;
        width: 600px;
        height: 400px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        margin: 0 auto;
    }

    .player-marker, .ai-marker {
        position: absolute;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        transform: translate(-15px, -15px);
    }

    .player-marker {
        background: blue;
    }

    .ai-marker {
        background: red;
        width: 24px;
        height: 24px;
        transform: translate(-12px, -12px);
    }

    .player-label, .ai-label {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 10px;
        white-space: nowrap;
        background: rgba(255,255,255,0.8);
        padding: 2px 4px;
        border-radius: 2px;
    }
</style>

@code {
    public class GameStateDto
    {
        public List<PlayerDto> Players { get; set; } = new();
        public PositionDto AIPosition { get; set; } = new();
    }

    public class PlayerDto
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int Health { get; set; }
        public int MaxHealth { get; set; }
        public float PositionX { get; set; }
        public float PositionY { get; set; }
        public bool IsAlive { get; set; }
    }

    public class PositionDto
    {
        public float X { get; set; }
        public float Y { get; set; }
    }
}
